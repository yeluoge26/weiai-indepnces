<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¾®çˆ± - AIä¼´ä¾£</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --primary: #FF6B9D;
      --primary-dark: #E91E63;
      --secondary: #9C27B0;
      --bg: #F5F5F5;
      --card-bg: #FFFFFF;
      --text: #333333;
      --text-secondary: #666666;
      --text-muted: #999999;
      --border: #E0E0E0;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #F44336;
      --gold: #FFD700;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .app { max-width: 480px; margin: 0 auto; background: var(--bg); min-height: 100vh; padding-bottom: 70px; position: relative; overflow-x: hidden; }
    .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .header-title { font-size: 18px; font-weight: 600; }
    .header-back { font-size: 24px; cursor: pointer; padding: 4px 8px; }
    .header-actions { display: flex; gap: 12px; }
    .header-action { font-size: 20px; cursor: pointer; padding: 4px; }
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: white; display: flex; justify-content: space-around; padding: 8px 0 12px; border-top: 1px solid var(--border); z-index: 100; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; color: var(--text-muted); font-size: 11px; transition: color 0.2s; }
    .nav-item.active { color: var(--primary); }
    .nav-item .icon { font-size: 22px; }
    .card { background: var(--card-bg); border-radius: 12px; padding: 16px; margin: 12px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border-radius: 24px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    .btn-gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: #8B4513; }
    .input { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s; }
    .input:focus { border-color: var(--primary); }
    .avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: 600; overflow: hidden; flex-shrink: 0; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-large { width: 80px; height: 80px; font-size: 32px; }
    .avatar-small { width: 36px; height: 36px; font-size: 16px; }
    .list-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; cursor: pointer; transition: background 0.2s; }
    .list-item:active { background: #f8f8f8; }
    .list-item:not(:last-child) { border-bottom: 1px solid var(--border); }
    .list-item-content { flex: 1; min-width: 0; }
    .list-item-title { font-size: 15px; font-weight: 500; }
    .list-item-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .category-tabs { display: flex; gap: 8px; padding: 12px 16px; overflow-x: auto; background: white; -webkit-overflow-scrolling: touch; }
    .category-tabs::-webkit-scrollbar { display: none; }
    .category-tab { padding: 6px 16px; border-radius: 16px; background: var(--bg); font-size: 13px; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
    .category-tab.active { background: var(--primary); color: white; }
    .character-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 12px 16px; }
    .character-card { background: white; border-radius: 12px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .character-card:active { transform: scale(0.98); }
    .character-card .avatar-section { height: 120px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; position: relative; }
    .character-card .avatar-section .avatar { width: 64px; height: 64px; font-size: 28px; border: 3px solid white; }
    .character-card .rpg-badge { position: absolute; top: 8px; left: 8px; background: linear-gradient(135deg, #9C27B0, #673AB7); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
    .character-card .info { padding: 12px; }
    .character-card .name { font-size: 14px; font-weight: 600; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .character-card .desc { font-size: 12px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 8px; }
    .character-card .stats { display: flex; gap: 12px; font-size: 11px; color: var(--text-secondary); }
    .character-card .personality-tag { display: inline-block; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
    .character-detail-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 60px 20px 30px; text-align: center; color: white; position: relative; }
    .character-detail-header .back-btn { position: absolute; top: 12px; left: 12px; font-size: 28px; cursor: pointer; padding: 4px 8px; }
    .character-detail-header .share-btn { position: absolute; top: 12px; right: 12px; font-size: 20px; cursor: pointer; padding: 4px 8px; }
    .character-detail-header .avatar { margin: 0 auto 12px; border: 4px solid white; }
    .character-detail-header .name { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
    .character-detail-header .tags { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
    .character-detail-header .tag { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; font-size: 12px; }
    .character-detail-stats { display: flex; justify-content: space-around; padding: 20px; background: white; margin: -15px 16px 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .character-detail-stats .stat { text-align: center; }
    .character-detail-stats .stat-value { font-size: 20px; font-weight: 600; color: var(--primary); }
    .character-detail-stats .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .character-detail-content { padding: 0 16px 100px; }
    .character-detail-section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .character-detail-section h3 { font-size: 15px; margin-bottom: 12px; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .character-detail-section h3::before { content: ''; width: 3px; height: 16px; background: var(--primary); border-radius: 2px; }
    .character-detail-section p { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
    .character-detail-actions { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; padding: 12px 16px; background: white; display: flex; gap: 12px; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); }
    .character-detail-actions .btn { flex: 1; }
    .chat-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 12px 16px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; }
    .chat-header .back-btn { font-size: 24px; cursor: pointer; padding: 4px; }
    .chat-header .info { flex: 1; cursor: pointer; }
    .chat-header .name { font-size: 16px; font-weight: 600; }
    .chat-header .affinity { font-size: 12px; opacity: 0.9; }
    .chat-header .actions { display: flex; gap: 12px; }
    .chat-header .action { font-size: 20px; cursor: pointer; padding: 4px; }
    .chat-messages { padding: 16px; min-height: calc(100vh - 130px); padding-bottom: 80px; }
    .message { display: flex; gap: 8px; margin-bottom: 16px; align-items: flex-start; }
    .message.sent { flex-direction: row-reverse; }
    .message .bubble { max-width: 70%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.5; word-break: break-word; }
    .message.received .bubble { background: white; border-bottom-left-radius: 4px; }
    .message.sent .bubble { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-bottom-right-radius: 4px; }
    .message .avatar { width: 36px; height: 36px; font-size: 14px; }
    .chat-input-area { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; padding: 12px 16px; background: white; display: flex; gap: 12px; align-items: center; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); }
    .chat-input-area .input { flex: 1; border-radius: 20px; padding: 10px 16px; }
    .chat-input-area .send-btn { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .chat-input-area .extra-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; color: var(--text-muted); }
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; }
    .gift-panel { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: white; border-radius: 16px 16px 0 0; padding: 20px; z-index: 201; max-height: 70vh; overflow-y: auto; }
    .gift-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .gift-panel-header h3 { font-size: 18px; }
    .gift-panel-header .close { font-size: 24px; cursor: pointer; color: var(--text-muted); }
    .gift-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
    .gift-item { text-align: center; padding: 12px 8px; border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .gift-item:active { transform: scale(0.95); }
    .gift-item.selected { border-color: var(--primary); background: rgba(255,107,157,0.1); }
    .gift-item .icon { font-size: 32px; margin-bottom: 4px; }
    .gift-item .name { font-size: 12px; margin-bottom: 2px; }
    .gift-item .price { font-size: 11px; color: var(--gold); }
    .gift-item .affinity { font-size: 10px; color: var(--primary); }
    .redpacket-panel { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: white; border-radius: 16px 16px 0 0; padding: 20px; z-index: 201; }
    .redpacket-panel h3 { text-align: center; margin-bottom: 20px; font-size: 18px; }
    .redpacket-panel .input { margin-bottom: 12px; }
    .redpacket-panel .btn { width: 100%; margin-top: 8px; background: linear-gradient(135deg, #FF4444, #CC0000); color: white; }
    .redpacket-amounts { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
    .redpacket-amount { padding: 10px; text-align: center; background: #fff5f5; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
    .redpacket-amount.selected { border-color: #FF4444; background: #ffe5e5; }
    .redpacket-amount .value { font-size: 16px; font-weight: 600; color: #FF4444; }
    .redpacket-amount .label { font-size: 10px; color: var(--text-muted); }
    .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 300; animation: fadeIn 0.2s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; color: var(--text-muted); }
    .loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
    .login-page { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 40px 24px; background: linear-gradient(135deg, var(--primary), var(--secondary)); }
    .login-page .logo { text-align: center; margin-bottom: 40px; }
    .login-page .logo h1 { color: white; font-size: 36px; margin-bottom: 8px; }
    .login-page .logo p { color: rgba(255,255,255,0.8); font-size: 14px; }
    .login-page .form { background: white; border-radius: 16px; padding: 24px; }
    .login-page .form-group { margin-bottom: 16px; }
    .login-page .form-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
    .login-page .tabs { display: flex; margin-bottom: 20px; }
    .login-page .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 2px solid var(--border); color: var(--text-muted); transition: all 0.2s; }
    .login-page .tab.active { border-bottom-color: var(--primary); color: var(--primary); }
    .settings-list { background: white; margin: 12px 16px; border-radius: 12px; overflow: hidden; }
    .settings-item { display: flex; align-items: center; padding: 14px 16px; cursor: pointer; transition: background 0.2s; }
    .settings-item:active { background: #f8f8f8; }
    .settings-item:not(:last-child) { border-bottom: 1px solid var(--border); }
    .settings-item .icon { font-size: 20px; margin-right: 12px; }
    .settings-item .label { flex: 1; font-size: 15px; }
    .settings-item .arrow { color: var(--text-muted); }
    .settings-item .value { color: var(--text-muted); font-size: 14px; margin-right: 8px; }
    .vip-header { background: linear-gradient(135deg, #FFD700, #FFA500); padding: 30px 20px; text-align: center; color: #8B4513; }
    .vip-header .icon { font-size: 48px; margin-bottom: 12px; }
    .vip-header h2 { font-size: 24px; margin-bottom: 8px; }
    .vip-levels { display: flex; gap: 12px; padding: 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .vip-levels::-webkit-scrollbar { display: none; }
    .vip-level { min-width: 140px; background: white; border-radius: 12px; padding: 16px; text-align: center; border: 2px solid transparent; flex-shrink: 0; }
    .vip-level.current { border-color: var(--gold); }
    .vip-level .name { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .vip-level .price { color: var(--gold); font-size: 14px; }
    .wallet-header { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 30px 20px; color: white; text-align: center; }
    .wallet-header .balance { font-size: 36px; font-weight: 600; margin-bottom: 8px; }
    .wallet-header .label { font-size: 14px; opacity: 0.8; }
    .wallet-stats { display: flex; justify-content: space-around; padding: 16px; background: white; margin: -20px 16px 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .wallet-stats .stat { text-align: center; }
    .wallet-stats .stat-value { font-size: 18px; font-weight: 600; }
    .wallet-stats .stat-label { font-size: 12px; color: var(--text-muted); }
    .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px; }
    .shop-item { background: white; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: transform 0.2s; }
    .shop-item:active { transform: scale(0.98); }
    .shop-item .icon { font-size: 40px; margin-bottom: 8px; }
    .shop-item .name { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
    .shop-item .price { font-size: 14px; color: var(--gold); font-weight: 600; }
    .shop-item .desc { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    .rank-tabs { display: flex; background: white; padding: 12px 16px; gap: 8px; }
    .rank-tab { flex: 1; padding: 8px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .rank-tab.active { background: var(--primary); color: white; }
    .rank-list { padding: 16px; }
    .rank-item { display: flex; align-items: center; gap: 12px; background: white; padding: 12px 16px; border-radius: 12px; margin-bottom: 8px; }
    .rank-item .rank-num { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
    .rank-item .rank-num.top1 { color: #FFD700; font-size: 20px; }
    .rank-item .rank-num.top2 { color: #C0C0C0; font-size: 18px; }
    .rank-item .rank-num.top3 { color: #CD7F32; font-size: 16px; }
    .rank-item .info { flex: 1; }
    .rank-item .name { font-size: 15px; font-weight: 500; }
    .rank-item .value { font-size: 13px; color: var(--text-muted); }
    .rank-item .score { font-size: 16px; font-weight: 600; color: var(--primary); }
    .moment-item { background: white; padding: 16px; margin-bottom: 8px; }
    .moment-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .moment-header .info { flex: 1; }
    .moment-header .name { font-size: 15px; font-weight: 500; }
    .moment-header .time { font-size: 12px; color: var(--text-muted); }
    .moment-content { font-size: 14px; line-height: 1.6; margin-bottom: 12px; }
    .moment-images { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 12px; }
    .moment-images img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; }
    .moment-actions { display: flex; gap: 24px; padding-top: 8px; border-top: 1px solid var(--border); }
    .moment-action { display: flex; align-items: center; gap: 4px; font-size: 13px; color: var(--text-muted); cursor: pointer; }
    .checkin-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 16px; background: white; border-radius: 12px; margin: 16px; }
    .checkin-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 12px; background: var(--bg); }
    .checkin-day.checked { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
    .checkin-day.today { border: 2px solid var(--primary); }
    .checkin-day .day { font-weight: 600; }
    .checkin-day .reward { font-size: 10px; opacity: 0.8; }
    .hidden { display: none !important; }
    .swipe-indicator { position: fixed; left: 0; top: 50%; transform: translateY(-50%); width: 20px; height: 100px; background: linear-gradient(to right, rgba(0,0,0,0.1), transparent); border-radius: 0 50px 50px 0; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 50; }
    .swipe-indicator.active { opacity: 1; }
    .post-moment-panel { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: white; border-radius: 16px 16px 0 0; padding: 20px; z-index: 201; max-height: 80vh; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="app" id="app"><div class="loading"><div class="loading-spinner"></div>åŠ è½½ä¸­...</div></div>
  <div class="swipe-indicator" id="swipeIndicator"></div>
<script>
const API_BASE='/api';
const state={token:localStorage.getItem('token'),user:null,currentPage:'home',pageHistory:['home'],characters:[],sessions:[],contacts:[],messages:[],gifts:[],moments:[],wallet:null,currentSession:null,currentCharacter:null,currentCategory:'å…¨éƒ¨',showGiftPanel:false,showRedPacketPanel:false,showPostMomentPanel:false,selectedGift:null,selectedRedPacketAmount:null,myCharacters:[],rankType:'affinity',rankings:[],shopItems:[]};
let touchStartX=0,touchStartY=0,isSwiping=false;
document.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;isSwiping=touchStartX<30;},{passive:true});
document.addEventListener('touchmove',e=>{if(!isSwiping)return;const diffX=e.touches[0].clientX-touchStartX;const diffY=Math.abs(e.touches[0].clientY-touchStartY);if(diffX>30&&diffX>diffY*2)document.getElementById('swipeIndicator').classList.add('active');},{passive:true});
document.addEventListener('touchend',e=>{document.getElementById('swipeIndicator').classList.remove('active');if(!isSwiping)return;if(e.changedTouches[0].clientX-touchStartX>100)goBack();isSwiping=false;},{passive:true});
function goBack(){if(state.pageHistory.length>1){state.pageHistory.pop();state.currentPage=state.pageHistory[state.pageHistory.length-1];render();}}
async function api(endpoint,options={}){const headers={'Content-Type':'application/json',...options.headers};if(state.token)headers['Authorization']=`Bearer ${state.token}`;try{const response=await fetch(`${API_BASE}${endpoint}`,{...options,headers});const data=await response.json();if(!response.ok)throw new Error(data.error?.message||data.message||'è¯·æ±‚å¤±è´¥');return data;}catch(error){console.error('API Error:',error);throw error;}}
function showToast(message){const existing=document.querySelector('.toast');if(existing)existing.remove();const toast=document.createElement('div');toast.className='toast';toast.textContent=message;document.body.appendChild(toast);setTimeout(()=>toast.remove(),2000);}
function getAvatar(name,avatarUrl){if(avatarUrl&&(avatarUrl.startsWith('http')||avatarUrl.startsWith('/uploads')))return `<img src="${avatarUrl}" alt="${name}" onerror="this.parentElement.innerHTML='${name?name.charAt(0).toUpperCase():'?'}'">`;return name?name.charAt(0).toUpperCase():'?';}
function formatTime(dateStr){if(!dateStr)return '';const date=new Date(dateStr);const now=new Date();const diff=now-date;if(diff<60000)return 'åˆšåˆš';if(diff<3600000)return Math.floor(diff/60000)+'åˆ†é’Ÿå‰';if(diff<86400000)return Math.floor(diff/3600000)+'å°æ—¶å‰';if(diff<604800000)return Math.floor(diff/86400000)+'å¤©å‰';return date.toLocaleDateString('zh-CN');}
function navigate(page,params={}){if(state.currentPage!==page)state.pageHistory.push(page);state.currentPage=page;switch(page){case 'home':loadHomeData().then(()=>render());break;case 'characters':loadCharacters().then(()=>render());break;case 'chat':loadSessions().then(()=>render());break;case 'contacts':loadContacts().then(()=>render());break;case 'discover':case 'moments':loadMoments().then(()=>render());break;case 'ranking':loadRankings().then(()=>render());break;case 'myCharacters':loadMyCharacters().then(()=>render());break;case 'settings':loadWallet().then(()=>render());break;case 'shop':loadShopItems().then(()=>render());break;default:render();}}
function render(){const app=document.getElementById('app');if(!state.token){app.innerHTML=renderLoginPage();return;}let content='';switch(state.currentPage){case 'home':content=renderHomePage();break;case 'characters':content=renderCharactersPage();break;case 'characterDetail':content=renderCharacterDetailPage();break;case 'chat':content=renderChatListPage();break;case 'chatRoom':content=renderChatRoomPage();break;case 'contacts':content=renderContactsPage();break;case 'discover':content=renderDiscoverPage();break;case 'moments':content=renderMomentsPage();break;case 'shop':content=renderShopPage();break;case 'ranking':content=renderRankingPage();break;case 'settings':content=renderSettingsPage();break;case 'vip':content=renderVipPage();break;case 'wallet':content=renderWalletPage();break;case 'checkin':content=renderCheckinPage();break;case 'invite':content=renderInvitePage();break;case 'about':content=renderAboutPage();break;case 'myCharacters':content=renderMyCharactersPage();break;case 'createCharacter':content=renderCreateCharacterPage();break;case 'apiConfig':content=renderApiConfigPage();break;case 'voiceSettings':content=renderVoiceSettingsPage();break;default:content=renderHomePage();}app.innerHTML=`<div class="page-container">${content}</div>`;window.scrollTo(0,0);}
function renderBottomNav(active){const items=[{id:'home',icon:'ğŸ’¬',label:'èŠå¤©'},{id:'contacts',icon:'ğŸ“‡',label:'é€šè®¯å½•'},{id:'characters',icon:'ğŸ­',label:'è§’è‰²'},{id:'discover',icon:'ğŸ”',label:'å‘ç°'},{id:'settings',icon:'ğŸ‘¤',label:'æˆ‘çš„'}];return `<div class="bottom-nav">${items.map(item=>`<div class="nav-item ${active===item.id?'active':''}" onclick="navigate('${item.id}')"><span class="icon">${item.icon}</span><span>${item.label}</span></div>`).join('')}</div>`;}
function renderLoginPage(){return `<div class="login-page"><div class="logo"><h1>å¾®çˆ±</h1><p>AIä¼´ä¾£ï¼Œæ¸©æš–ç›¸ä¼´</p></div><div class="form"><div class="tabs"><div class="tab active" onclick="switchTab('login')">ç™»å½•</div><div class="tab" onclick="switchTab('register')">æ³¨å†Œ</div></div><div id="loginForm"><div class="form-group"><label>ç”¨æˆ·å</label><input type="text" class="input" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"></div><div class="form-group"><label>å¯†ç </label><input type="password" class="input" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç "></div><button class="btn btn-primary" style="width:100%;margin-top:12px;" onclick="handleLogin()">ç™»å½•</button></div><div id="registerForm" class="hidden"><div class="form-group"><label>ç”¨æˆ·å</label><input type="text" class="input" id="regUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"></div><div class="form-group"><label>é‚®ç®±</label><input type="email" class="input" id="regEmail" placeholder="è¯·è¾“å…¥é‚®ç®±"></div><div class="form-group"><label>å¯†ç </label><input type="password" class="input" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç "></div><button class="btn btn-primary" style="width:100%;margin-top:12px;" onclick="handleRegister()">æ³¨å†Œ</button></div></div></div>`;}
function switchTab(tab){const loginForm=document.getElementById('loginForm');const registerForm=document.getElementById('registerForm');const tabs=document.querySelectorAll('.login-page .tab');if(tab==='login'){loginForm.classList.remove('hidden');registerForm.classList.add('hidden');tabs[0].classList.add('active');tabs[1].classList.remove('active');}else{loginForm.classList.add('hidden');registerForm.classList.remove('hidden');tabs[0].classList.remove('active');tabs[1].classList.add('active');}}
async function handleLogin(){const username=document.getElementById('loginUsername').value;const password=document.getElementById('loginPassword').value;if(!username||!password){showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');return;}try{const data=await api('/auth/login',{method:'POST',body:JSON.stringify({username,password})});state.token=data.token;state.user=data.user;localStorage.setItem('token',data.token);await loadInitialData();navigate('home');showToast('ç™»å½•æˆåŠŸ');}catch(error){showToast(error.message);}}
async function handleRegister(){const username=document.getElementById('regUsername').value;const email=document.getElementById('regEmail').value;const password=document.getElementById('regPassword').value;if(!username||!email||!password){showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');return;}try{const data=await api('/auth/register',{method:'POST',body:JSON.stringify({username,email,password})});state.token=data.token;state.user=data.user;localStorage.setItem('token',data.token);await loadInitialData();navigate('home');showToast('æ³¨å†ŒæˆåŠŸï¼Œå·²èµ é€100ç§¯åˆ†å’Œ50é‡‘å¸');}catch(error){showToast(error.message);}}
function getCategoryLabel(category){const labels={'assistant':'åŠ©æ‰‹','companion':'ä¼´ä¾£','rpg':'RPG','xianxia':'ä»™ä¾ ','urban':'éƒ½å¸‚','scifi':'ç§‘å¹»','interstellar':'æ˜Ÿé™…','cultivation':'ä¿®çœŸ','otome':'ä¹™æ¸¸'};return labels[category]||category||'åŠ©æ‰‹';}
function getGradientByCategory(category){const gradients={'xianxia':'linear-gradient(135deg, #667eea, #764ba2)','urban':'linear-gradient(135deg, #11998e, #38ef7d)','scifi':'linear-gradient(135deg, #4facfe, #00f2fe)','interstellar':'linear-gradient(135deg, #0c0c0c, #434343)','cultivation':'linear-gradient(135deg, #f093fb, #f5576c)','otome':'linear-gradient(135deg, #ff9a9e, #fecfef)','assistant':'linear-gradient(135deg, #667eea, #764ba2)','companion':'linear-gradient(135deg, #FF6B9D, #9C27B0)'};return gradients[category]||'linear-gradient(135deg, #667eea, #764ba2)';}
function getPersonalityLabel(type){const labels={'gentle':'æ¸©æŸ”','cold':'é«˜å†·','lively':'æ´»æ³¼','domineering':'éœ¸é“','queenly':'å¾¡å§','cute':'å¯çˆ±'};return labels[type]||type;}
function renderHomePage(){return `<div class="header"><span class="header-title">å¾®çˆ±</span><div class="header-actions"><span class="header-action" onclick="navigate('checkin')">ğŸ“…</span><span class="header-action" onclick="navigate('characters')">ğŸ”</span></div></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><h3 style="font-size:16px;">æ¨èè§’è‰²</h3><a href="javascript:void(0)" onclick="navigate('characters')" style="color:var(--primary);font-size:13px;">æŸ¥çœ‹å…¨éƒ¨ â€º</a></div><div style="display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;-webkit-overflow-scrolling:touch;">${state.characters.length>0?state.characters.slice(0,6).map(char=>`<div style="min-width:80px;text-align:center;cursor:pointer;" onclick="viewCharacter(${char.id})"><div class="avatar" style="margin:0 auto 8px;">${getAvatar(char.name,char.avatar)}</div><div style="font-size:13px;font-weight:500;">${char.name}</div><div style="font-size:11px;color:var(--text-muted);">${getCategoryLabel(char.category)}</div></div>`).join(''):'<div class="loading"><div class="loading-spinner"></div></div>'}</div></div><div style="padding:0 16px;"><h3 style="font-size:16px;margin-bottom:12px;">æœ€è¿‘èŠå¤©</h3><div>${state.sessions.length>0?state.sessions.map(session=>`<div class="list-item" style="background:white;border-radius:12px;margin-bottom:8px;" onclick="openChatRoom(${session.id})"><div class="avatar">${getAvatar(session.characterName,session.characterAvatar)}</div><div class="list-item-content"><div class="list-item-title">${session.characterName||'æœªçŸ¥è§’è‰²'}</div><div class="list-item-subtitle">${session.lastMessage||'å¼€å§‹èŠå¤©å§'}</div></div><div style="font-size:12px;color:var(--text-muted);">${formatTime(session.updatedAt)}</div></div>`).join(''):`<div class="empty-state"><div class="icon">ğŸ’¬</div><p>è¿˜æ²¡æœ‰èŠå¤©è®°å½•</p><button class="btn btn-primary" style="margin-top:16px;" onclick="navigate('characters')">å¼€å§‹èŠå¤©</button></div>`}</div></div>${renderBottomNav('home')}`;}
function renderCharactersPage(){const categories=['å…¨éƒ¨','åŠ©æ‰‹','ä»™ä¾ ','éƒ½å¸‚','ç§‘å¹»','æ˜Ÿé™…','ä¿®çœŸ','ä¹™æ¸¸'];let filteredCharacters=state.characters;if(state.currentCategory!=='å…¨éƒ¨'){const categoryMap={'åŠ©æ‰‹':['assistant','companion'],'ä»™ä¾ ':['xianxia'],'éƒ½å¸‚':['urban'],'ç§‘å¹»':['scifi'],'æ˜Ÿé™…':['interstellar'],'ä¿®çœŸ':['cultivation'],'ä¹™æ¸¸':['otome']};const targetCategories=categoryMap[state.currentCategory]||[state.currentCategory.toLowerCase()];filteredCharacters=state.characters.filter(c=>targetCategories.includes(c.category)||targetCategories.includes(c.rpgSubCategory));}return `<div class="header"><span class="header-title">è§’è‰²å¹¿åœº</span><div class="header-actions"><span class="header-action" onclick="navigate('myCharacters')">ğŸ‘¤</span><span class="header-action" onclick="navigate('createCharacter')">â•</span></div></div><div class="category-tabs">${categories.map(cat=>`<div class="category-tab ${state.currentCategory===cat?'active':''}" onclick="filterCategory('${cat}')">${cat}</div>`).join('')}</div><div class="character-grid">${filteredCharacters.map(char=>`<div class="character-card" onclick="viewCharacter(${char.id})"><div class="avatar-section" style="background:${getGradientByCategory(char.category)}">${char.category==='rpg'||['xianxia','urban','scifi','interstellar','cultivation','otome'].includes(char.rpgSubCategory)?`<span class="rpg-badge">${getCategoryLabel(char.rpgSubCategory||char.category)}</span>`:''}<div class="avatar">${getAvatar(char.name,char.avatar)}</div></div><div class="info"><div class="name">${char.name}</div><div class="desc">${char.description||'æš‚æ— ä»‹ç»'}</div>${char.personalityType?`<span class="personality-tag">${getPersonalityLabel(char.personalityType)}</span>`:''}<div class="stats"><span>ğŸ’¬ ${char.usageCount||0}</span><span>â¤ï¸ ${char.likeCount||0}</span></div></div></div>`).join('')}</div>${renderBottomNav('characters')}`;}
function filterCategory(category){state.currentCategory=category;render();}
function renderCharacterDetailPage(){const char=state.currentCharacter;if(!char)return `<div class="loading"><div class="loading-spinner"></div>åŠ è½½ä¸­...</div>`;const isInContacts=state.contacts.some(c=>c.characterId===char.id);return `<div class="character-detail-header"><span class="back-btn" onclick="goBack()">â€¹</span><span class="share-btn" onclick="shareCharacter()">ğŸ“¤</span><div class="avatar avatar-large">${getAvatar(char.name,char.avatar)}</div><div class="name">${char.name}</div><div class="tags"><span class="tag">${getCategoryLabel(char.category||char.rpgSubCategory)}</span>${char.gender?`<span class="tag">${char.gender==='male'?'â™‚ ç”·':'â™€ å¥³'}</span>`:''}${char.personalityType?`<span class="tag">${getPersonalityLabel(char.personalityType)}</span>`:''}</div></div><div class="character-detail-stats"><div class="stat"><div class="stat-value">${char.usageCount||0}</div><div class="stat-label">å¯¹è¯æ•°</div></div><div class="stat"><div class="stat-value">${char.likeCount||0}</div><div class="stat-label">å–œæ¬¢</div></div><div class="stat"><div class="stat-value">${char.affinity?.level||'é™Œç”Ÿäºº'}</div><div class="stat-label">å¥½æ„Ÿåº¦</div></div></div><div class="character-detail-content"><div class="character-detail-section"><h3>è§’è‰²ä»‹ç»</h3><p>${char.description||'è¿™ä¸ªè§’è‰²è¿˜æ²¡æœ‰ä»‹ç»~'}</p></div>${char.personality?`<div class="character-detail-section"><h3>æ€§æ ¼ç‰¹ç‚¹</h3><p>${char.personality}</p></div>`:''}${char.scenario||char.backgroundStory?`<div class="character-detail-section"><h3>å‰§æƒ…ç®€ä»‹</h3><p>${char.scenario||char.backgroundStory}</p></div>`:''}</div><div class="character-detail-actions"><button class="btn btn-outline" onclick="${isInContacts?'removeFromContacts('+char.id+')':'addToContacts('+char.id+')'}">${isInContacts?'ç§»å‡ºé€šè®¯å½•':'åŠ å…¥é€šè®¯å½•'}</button><button class="btn btn-primary" onclick="startChat(${char.id})">å¼€å§‹èŠå¤©</button></div>`;}
async function viewCharacter(characterId){state.currentPage='characterDetail';state.pageHistory.push('characterDetail');state.currentCharacter=null;render();try{const charRes=await api(`/characters/${characterId}`);state.currentCharacter=charRes.character||charRes;if(state.token){try{const affinity=await api(`/affinity/${characterId}`);state.currentCharacter.affinity=affinity;}catch(e){state.currentCharacter.affinity={level:'é™Œç”Ÿäºº',points:0};}}render();}catch(error){console.error('Load character error:',error);showToast('åŠ è½½è§’è‰²å¤±è´¥');}}
async function addToContacts(characterId){try{await api('/contacts',{method:'POST',body:JSON.stringify({characterId})});showToast('å·²åŠ å…¥é€šè®¯å½•');await loadContacts();render();}catch(error){showToast(error.message);}}
async function removeFromContacts(characterId){try{await api(`/contacts/${characterId}`,{method:'DELETE'});showToast('å·²ç§»å‡ºé€šè®¯å½•');await loadContacts();render();}catch(error){showToast(error.message);}}
async function startChat(characterId){try{const char=state.currentCharacter||state.characters.find(c=>c.id===characterId);const response=await api('/chat/sessions',{method:'POST',body:JSON.stringify({characterId})});const sessionData=response.session||response;state.currentSession={id:sessionData.id,sessionId:sessionData.sessionId,characterId:characterId,characterName:char?.name||sessionData.character?.name||sessionData.characterName||'AIä¼´ä¾£',characterAvatar:char?.avatar||sessionData.character?.avatar||sessionData.characterAvatar,affinityLevel:char?.affinity?.level||'é™Œç”Ÿäºº'};state.messages=[];state.currentPage='chatRoom';state.pageHistory.push('chatRoom');render();}catch(error){showToast(error.message);}}
function shareCharacter(){const char=state.currentCharacter;if(!char)return;if(navigator.share){navigator.share({title:char.name,text:char.description,url:window.location.href});}else{navigator.clipboard.writeText(window.location.href).then(()=>{showToast('é“¾æ¥å·²å¤åˆ¶');}).catch(()=>{showToast('åˆ†äº«åŠŸèƒ½æš‚ä¸å¯ç”¨');});}}
function renderChatListPage(){return `<div class="header"><span class="header-title">èŠå¤©</span></div><div style="padding:8px 0;">${state.sessions.length>0?state.sessions.map(session=>`<div class="list-item" onclick="openChatRoom(${session.id})"><div class="avatar">${getAvatar(session.characterName,session.characterAvatar)}</div><div class="list-item-content"><div class="list-item-title">${session.characterName||'æœªçŸ¥è§’è‰²'}</div><div class="list-item-subtitle">${session.lastMessage||'å¼€å§‹èŠå¤©å§'}</div></div><div style="font-size:12px;color:var(--text-muted);">${formatTime(session.updatedAt)}</div></div>`).join(''):`<div class="empty-state"><div class="icon">ğŸ’¬</div><p>è¿˜æ²¡æœ‰èŠå¤©è®°å½•</p><button class="btn btn-primary" style="margin-top:16px;" onclick="navigate('characters')">å¼€å§‹èŠå¤©</button></div>`}</div>${renderBottomNav('home')}`;}
async function openChatRoom(sessionId){try{const session=state.sessions.find(s=>s.id===sessionId);state.currentSession=session;const messages=await api(`/chat/sessions/${sessionId}/messages`);state.messages=messages||[];state.currentPage='chatRoom';state.pageHistory.push('chatRoom');render();setTimeout(()=>{const container=document.getElementById('chatMessages');if(container)container.scrollTop=container.scrollHeight;},100);}catch(error){showToast(error.message);}}
function renderChatRoomPage(){const rawSession=state.currentSession;if(!rawSession)return `<div class="loading"><div class="loading-spinner"></div>åŠ è½½ä¸­...</div>`;const session=rawSession.session||rawSession;const charName=session.character?.name||session.characterName||rawSession.characterName||'èŠå¤©';const charAvatar=session.character?.avatar||session.characterAvatar||rawSession.characterAvatar;const charId=session.characterId||rawSession.characterId;const affLevel=rawSession.affinityLevel||session.affinityLevel||'é™Œç”Ÿäºº';return `<div class="chat-header"><span class="back-btn" onclick="goBack()">â€¹</span><div class="info" onclick="viewCharacter(${charId})"><div class="name">${charName}</div><div class="affinity">å¥½æ„Ÿåº¦ ${affLevel}</div></div><div class="actions"><span class="action" onclick="openGiftPanel()">ğŸ</span><span class="action" onclick="openRedPacketPanel()">ğŸ§§</span><span class="action">ğŸ”Š</span></div></div><div class="chat-messages" id="chatMessages">${state.messages.length>0?state.messages.map(msg=>`<div class="message ${msg.role==='user'?'sent':'received'}">${msg.role!=='user'?`<div class="avatar avatar-small">${getAvatar(charName,charAvatar)}</div>`:''}<div class="bubble">${msg.content}</div></div>`).join(''):`<div class="empty-state" style="padding-top:60px;"><div class="icon">ğŸ’¬</div><p>å¼€å§‹å’Œ${charName}èŠå¤©å§</p></div>`}</div><div class="chat-input-area"><span class="extra-btn" onclick="openGiftPanel()">ğŸ</span><input type="text" class="input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')sendMessage()"><button class="send-btn" onclick="sendMessage()">â¤</button></div>${state.showGiftPanel?renderGiftPanel():''}${state.showRedPacketPanel?renderRedPacketPanel():''}`;}
async function sendMessage(){const input=document.getElementById('messageInput');const content=input.value.trim();if(!content||!state.currentSession)return;input.value='';state.messages.push({role:'user',content});render();setTimeout(()=>{const container=document.getElementById('chatMessages');if(container)container.scrollTop=container.scrollHeight;},50);try{const response=await api(`/chat/sessions/${state.currentSession.id}/messages`,{method:'POST',body:JSON.stringify({content})});if(response.aiMessage){state.messages.push({role:'assistant',content:response.aiMessage.content});render();}setTimeout(()=>{const container=document.getElementById('chatMessages');if(container)container.scrollTop=container.scrollHeight;},100);}catch(error){showToast(error.message);}}
function renderGiftPanel(){const gifts=state.gifts.length>0?state.gifts:[{id:1,giftId:'rose',name:'ç«ç‘°',icon:'ğŸŒ¹',price:10,affinityPoints:5},{id:2,giftId:'chocolate',name:'å·§å…‹åŠ›',icon:'ğŸ«',price:20,affinityPoints:10},{id:3,giftId:'cake',name:'è›‹ç³•',icon:'ğŸ‚',price:50,affinityPoints:25},{id:4,giftId:'ring',name:'æˆ’æŒ‡',icon:'ğŸ’',price:100,affinityPoints:50},{id:5,giftId:'crown',name:'çš‡å† ',icon:'ğŸ‘‘',price:200,affinityPoints:100},{id:6,giftId:'rocket',name:'ç«ç®­',icon:'ğŸš€',price:500,affinityPoints:250},{id:7,giftId:'castle',name:'åŸå ¡',icon:'ğŸ°',price:1000,affinityPoints:500},{id:8,giftId:'heart',name:'çˆ±å¿ƒ',icon:'â¤ï¸',price:5,affinityPoints:2}];return `<div class="overlay" onclick="closeGiftPanel()"></div><div class="gift-panel"><div class="gift-panel-header"><h3>é€ç¤¼ç‰©</h3><span class="close" onclick="closeGiftPanel()">Ã—</span></div><div style="text-align:center;margin-bottom:12px;color:var(--text-muted);font-size:13px;">æˆ‘çš„é‡‘å¸: <span style="color:var(--gold);font-weight:600;">${state.wallet?.coins||0}</span></div><div class="gift-grid">${gifts.map(gift=>`<div class="gift-item ${state.selectedGift?.id===gift.id?'selected':''}" onclick="selectGift(${gift.id})"><div class="icon">${gift.icon}</div><div class="name">${gift.name}</div><div class="price">ğŸ’° ${gift.price}</div><div class="affinity">+${gift.affinityPoints||gift.affinity||5}å¥½æ„Ÿ</div></div>`).join('')}</div><button class="btn btn-primary" style="width:100%;" onclick="sendGift()" ${!state.selectedGift?'disabled':''}>é€å‡ºç¤¼ç‰© ${state.selectedGift?`(${state.selectedGift.price}é‡‘å¸)`:''}</button></div>`;}
function openGiftPanel(){state.showGiftPanel=true;state.selectedGift=null;loadGifts().then(()=>render());}
function closeGiftPanel(){state.showGiftPanel=false;render();}
function selectGift(giftId){const gifts=state.gifts.length>0?state.gifts:[{id:1,giftId:'rose',name:'ç«ç‘°',icon:'ğŸŒ¹',price:10,affinityPoints:5},{id:2,giftId:'chocolate',name:'å·§å…‹åŠ›',icon:'ğŸ«',price:20,affinityPoints:10},{id:3,giftId:'cake',name:'è›‹ç³•',icon:'ğŸ‚',price:50,affinityPoints:25},{id:4,giftId:'ring',name:'æˆ’æŒ‡',icon:'ğŸ’',price:100,affinityPoints:50},{id:5,giftId:'crown',name:'çš‡å† ',icon:'ğŸ‘‘',price:200,affinityPoints:100},{id:6,giftId:'rocket',name:'ç«ç®­',icon:'ğŸš€',price:500,affinityPoints:250},{id:7,giftId:'castle',name:'åŸå ¡',icon:'ğŸ°',price:1000,affinityPoints:500},{id:8,giftId:'heart',name:'çˆ±å¿ƒ',icon:'â¤ï¸',price:5,affinityPoints:2}];state.selectedGift=gifts.find(g=>g.id===giftId);render();}
async function sendGift(){if(!state.selectedGift||!state.currentSession){showToast('è¯·é€‰æ‹©ç¤¼ç‰©');return;}if((state.wallet?.coins||0)<state.selectedGift.price){showToast('é‡‘å¸ä¸è¶³ï¼Œè¯·å…ˆå……å€¼');return;}try{await api('/gifts/send',{method:'POST',body:JSON.stringify({giftId:state.selectedGift.giftId||state.selectedGift.id,characterId:state.currentSession.characterId,quantity:1})});showToast(`æˆåŠŸé€å‡º ${state.selectedGift.name}ï¼Œå¥½æ„Ÿåº¦+${state.selectedGift.affinityPoints||5}`);closeGiftPanel();await loadWallet();}catch(error){showToast(error.message);}}
function renderRedPacketPanel(){const amounts=[{value:10,label:'å°çº¢åŒ…'},{value:50,label:'ä¸­çº¢åŒ…'},{value:100,label:'å¤§çº¢åŒ…'},{value:520,label:'æˆ‘çˆ±ä½ '}];return `<div class="overlay" onclick="closeRedPacketPanel()"></div><div class="redpacket-panel"><h3>ğŸ§§ å‘çº¢åŒ…</h3><div style="text-align:center;margin-bottom:12px;color:var(--text-muted);font-size:13px;">æˆ‘çš„é‡‘å¸: <span style="color:var(--gold);font-weight:600;">${state.wallet?.coins||0}</span></div><div class="redpacket-amounts">${amounts.map(a=>`<div class="redpacket-amount ${state.selectedRedPacketAmount===a.value?'selected':''}" onclick="selectRedPacketAmount(${a.value})"><div class="value">${a.value}</div><div class="label">${a.label}</div></div>`).join('')}</div><input type="number" class="input" id="redpacketAmount" placeholder="è¾“å…¥é‡‘é¢" value="${state.selectedRedPacketAmount||''}"><input type="text" class="input" id="redpacketMessage" placeholder="ç¥ç¦è¯­ï¼ˆé€‰å¡«ï¼‰"><button class="btn" onclick="sendRedPacket()">å‘çº¢åŒ…</button><button class="btn btn-outline" style="margin-top:8px;width:100%;" onclick="closeRedPacketPanel()">å–æ¶ˆ</button></div>`;}
function openRedPacketPanel(){state.showRedPacketPanel=true;state.selectedRedPacketAmount=null;render();}
function closeRedPacketPanel(){state.showRedPacketPanel=false;render();}
function selectRedPacketAmount(amount){state.selectedRedPacketAmount=amount;render();setTimeout(()=>{const input=document.getElementById('redpacketAmount');if(input)input.value=amount;},50);}
async function sendRedPacket(){const amountInput=document.getElementById('redpacketAmount');const amount=parseInt(amountInput?.value||state.selectedRedPacketAmount);const message=document.getElementById('redpacketMessage')?.value||'';if(!amount||amount<1){showToast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');return;}if((state.wallet?.coins||0)<amount){showToast('é‡‘å¸ä¸è¶³ï¼Œè¯·å…ˆå……å€¼');return;}try{await api('/redpackets/send',{method:'POST',body:JSON.stringify({characterId:state.currentSession.characterId,amount,message})});showToast('çº¢åŒ…å‘é€æˆåŠŸ');closeRedPacketPanel();await loadWallet();}catch(error){showToast(error.message);}}
function renderContactsPage(){return `<div class="header"><span class="header-title">é€šè®¯å½•</span><div class="header-actions"><span class="header-action" onclick="navigate('characters')">â•</span></div></div><div style="padding:8px 0;">${state.contacts.length>0?state.contacts.map(contact=>`<div class="list-item" onclick="startChat(${contact.characterId})"><div class="avatar">${getAvatar(contact.characterName||contact.nickname,contact.characterAvatar)}</div><div class="list-item-content"><div class="list-item-title">${contact.nickname||contact.characterName}</div><div class="list-item-subtitle">å¥½æ„Ÿåº¦ ${contact.affinityLevelName||contact.affinityLevel||'é™Œç”Ÿäºº'}</div></div>${contact.isPinned?'<span style="color:var(--gold);">ğŸ“Œ</span>':''}</div>`).join(''):`<div class="empty-state"><div class="icon">ğŸ“‡</div><p>é€šè®¯å½•ç©ºç©ºå¦‚ä¹Ÿ</p><p style="font-size:13px;margin-top:8px;">å»è§’è‰²å¹¿åœºæ·»åŠ å–œæ¬¢çš„è§’è‰²å§</p><button class="btn btn-primary" style="margin-top:16px;" onclick="navigate('characters')">æ·»åŠ è§’è‰²</button></div>`}</div>${renderBottomNav('contacts')}`;}
function renderDiscoverPage(){return `<div class="header"><span class="header-title">å‘ç°</span></div><div class="card"><div class="list-item" style="padding:0;" onclick="navigate('moments')"><span style="font-size:24px;margin-right:12px;">ğŸ“·</span><span style="flex:1;">æœ‹å‹åœˆ</span><span style="color:var(--text-muted);">â€º</span></div></div><div class="card"><div class="list-item" style="padding:0;border:none;" onclick="navigate('shop')"><span style="font-size:24px;margin-right:12px;">ğŸ›’</span><span style="flex:1;">å•†åŸ</span><span style="color:var(--text-muted);">â€º</span></div></div><div class="card"><div class="list-item" style="padding:0;border:none;" onclick="navigate('ranking')"><span style="font-size:24px;margin-right:12px;">ğŸ†</span><span style="flex:1;">æ’è¡Œæ¦œ</span><span style="color:var(--text-muted);">â€º</span></div></div>${renderBottomNav('discover')}`;}
function renderMomentsPage(){return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">æœ‹å‹åœˆ</span><div class="header-actions"><span class="header-action" onclick="showPostMoment()">ğŸ“</span></div></div><div style="padding-top:8px;">${state.moments.length>0?state.moments.map(moment=>`<div class="moment-item"><div class="moment-header"><div class="avatar">${getAvatar(moment.authorName,moment.authorAvatar)}</div><div class="info"><div class="name">${moment.authorName}</div><div class="time">${formatTime(moment.createdAt)}</div></div></div><div class="moment-content">${moment.content}</div>${moment.images&&moment.images.length>0?`<div class="moment-images">${moment.images.map(img=>`<img src="${img}" alt="">`).join('')}</div>`:''}<div class="moment-actions"><div class="moment-action" onclick="likeMoment(${moment.id})">â¤ï¸ ${moment.likeCount||0}</div><div class="moment-action" onclick="commentMoment(${moment.id})">ğŸ’¬ ${moment.commentCount||0}</div></div></div>`).join(''):`<div class="empty-state"><div class="icon">ğŸ“·</div><p>è¿˜æ²¡æœ‰åŠ¨æ€</p><button class="btn btn-primary" style="margin-top:16px;" onclick="showPostMoment()">å‘å¸ƒåŠ¨æ€</button></div>`}</div>${state.showPostMomentPanel?renderPostMomentPanel():''}`;}
function showPostMoment(){state.showPostMomentPanel=true;render();}
function closePostMomentPanel(){state.showPostMomentPanel=false;render();}
function renderPostMomentPanel(){return `<div class="overlay" onclick="closePostMomentPanel()"></div><div class="post-moment-panel"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><h3>å‘å¸ƒåŠ¨æ€</h3><span style="font-size:24px;cursor:pointer;" onclick="closePostMomentPanel()">Ã—</span></div><textarea class="input" id="momentContent" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." style="height:120px;resize:none;margin-bottom:12px;"></textarea><button class="btn btn-primary" style="width:100%;" onclick="postMoment()">å‘å¸ƒ</button></div>`;}
async function postMoment(){const content=document.getElementById('momentContent')?.value?.trim();if(!content){showToast('è¯·è¾“å…¥å†…å®¹');return;}try{await api('/moments',{method:'POST',body:JSON.stringify({content})});showToast('å‘å¸ƒæˆåŠŸ');closePostMomentPanel();await loadMoments();render();}catch(error){showToast(error.message);}}
async function likeMoment(momentId){try{await api(`/moments/${momentId}/like`,{method:'POST'});showToast('ç‚¹èµæˆåŠŸ');await loadMoments();render();}catch(error){showToast(error.message);}}
function commentMoment(momentId){showToast('è¯„è®ºåŠŸèƒ½å¼€å‘ä¸­');}
function renderShopPage(){const items=state.shopItems.length>0?state.shopItems:[{id:1,name:'VIPæœˆå¡',icon:'ğŸ‘‘',price:30,desc:'æ¯æ—¥100æ¡æ¶ˆæ¯'},{id:2,name:'VIPå­£å¡',icon:'ğŸ’',price:80,desc:'æ¯æ—¥200æ¡æ¶ˆæ¯'},{id:3,name:'VIPå¹´å¡',icon:'ğŸ†',price:298,desc:'æ— é™æ¶ˆæ¯'},{id:4,name:'100é‡‘å¸',icon:'ğŸ’°',price:10,desc:'ç”¨äºé€ç¤¼ç‰©'},{id:5,name:'500é‡‘å¸',icon:'ğŸ’°',price:45,desc:'ç”¨äºé€ç¤¼ç‰©'},{id:6,name:'1000é‡‘å¸',icon:'ğŸ’°',price:80,desc:'ç”¨äºé€ç¤¼ç‰©'},{id:7,name:'è¯­éŸ³åŒ…',icon:'ğŸ”Š',price:20,desc:'è§£é”è¯­éŸ³å›å¤'},{id:8,name:'è¡¨æƒ…åŒ…',icon:'ğŸ˜Š',price:10,desc:'ä¸“å±è¡¨æƒ…'}];return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">å•†åŸ</span></div><div class="shop-grid">${items.map(item=>`<div class="shop-item" onclick="buyItem(${item.id})"><div class="icon">${item.icon}</div><div class="name">${item.name}</div><div class="price">Â¥${item.price}</div><div class="desc">${item.desc||item.description||''}</div></div>`).join('')}</div>`;}
async function loadShopItems(){try{const data=await api('/shop/items');state.shopItems=data.items||data||[];}catch(error){console.error('Load shop items error:',error);}}
function buyItem(itemId){showToast('æ”¯ä»˜åŠŸèƒ½å¼€å‘ä¸­');}
function renderRankingPage(){const tabs=[{id:'affinity',label:'å¥½æ„Ÿæ¦œ'},{id:'chat',label:'èŠå¤©æ¦œ'},{id:'gift',label:'é€ç¤¼æ¦œ'}];return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">æ’è¡Œæ¦œ</span></div><div class="rank-tabs">${tabs.map(tab=>`<div class="rank-tab ${state.rankType===tab.id?'active':''}" onclick="switchRankType('${tab.id}')">${tab.label}</div>`).join('')}</div><div class="rank-list">${state.rankings.length>0?state.rankings.map((item,index)=>`<div class="rank-item"><div class="rank-num ${index<3?'top'+(index+1):''}">${index<3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][index]:index+1}</div><div class="avatar avatar-small">${getAvatar(item.name,item.avatar)}</div><div class="info"><div class="name">${item.name}</div><div class="value">${item.subtitle||''}</div></div><div class="score">${item.score}</div></div>`).join(''):`<div class="empty-state"><div class="icon">ğŸ†</div><p>æš‚æ— æ’è¡Œæ•°æ®</p><p style="font-size:13px;margin-top:8px;">å¿«å»å’Œè§’è‰²äº’åŠ¨å§</p></div>`}</div>`;}
function switchRankType(type){state.rankType=type;loadRankings().then(()=>render());}
function renderSettingsPage(){return `<div class="header"><span class="header-title">æˆ‘çš„</span></div><div class="card" style="display:flex;align-items:center;gap:16px;"><div class="avatar avatar-large">${state.user?getAvatar(state.user.username||state.user.name):'?'}</div><div style="flex:1;"><div style="font-size:18px;font-weight:600;">${state.user?.username||state.user?.name||'ç”¨æˆ·'}</div><div style="font-size:13px;color:var(--text-muted);margin-top:4px;">${state.user?.vipLevel>0?`ğŸ‘‘ VIP${state.user.vipLevel}`:'æ™®é€šç”¨æˆ·'}</div></div></div><div class="settings-list"><div class="settings-item" onclick="navigate('vip')"><span class="icon">ğŸ‘‘</span><span class="label">VIPä¼šå‘˜</span><span class="value">${state.user?.vipLevel>0?'VIP'+state.user.vipLevel:'å¼€é€š'}</span><span class="arrow">â€º</span></div><div class="settings-item" onclick="navigate('wallet')"><span class="icon">ğŸ’°</span><span class="label">æˆ‘çš„é’±åŒ…</span><span class="value">${state.wallet?.coins||0} é‡‘å¸</span><span class="arrow">â€º</span></div><div class="settings-item" onclick="navigate('checkin')"><span class="icon">ğŸ“…</span><span class="label">æ¯æ—¥ç­¾åˆ°</span><span class="arrow">â€º</span></div><div class="settings-item" onclick="navigate('invite')"><span class="icon">ğŸ</span><span class="label">é‚€è¯·å¥½å‹</span><span class="arrow">â€º</span></div></div><div class="settings-list"><div class="settings-item" onclick="navigate('myCharacters')"><span class="icon">ğŸ­</span><span class="label">æˆ‘çš„è§’è‰²</span><span class="arrow">â€º</span></div><div class="settings-item" onclick="navigate('apiConfig')"><span class="icon">ğŸ”§</span><span class="label">APIé…ç½®</span><span class="arrow">â€º</span></div><div class="settings-item" onclick="navigate('voiceSettings')"><span class="icon">ğŸ”Š</span><span class="label">è¯­éŸ³è®¾ç½®</span><span class="arrow">â€º</span></div></div><div class="settings-list"><div class="settings-item" onclick="navigate('about')"><span class="icon">â„¹ï¸</span><span class="label">å…³äºæˆ‘ä»¬</span><span class="arrow">â€º</span></div><div class="settings-item" onclick="handleLogout()"><span class="icon">ğŸšª</span><span class="label" style="color:var(--danger);">é€€å‡ºç™»å½•</span></div></div>${renderBottomNav('settings')}`;}
function handleLogout(){state.token=null;state.user=null;localStorage.removeItem('token');render();showToast('å·²é€€å‡ºç™»å½•');}
function renderVipPage(){const levels=[{level:0,name:'æ™®é€šç”¨æˆ·',price:0,benefits:['æ¯æ—¥10æ¡æ¶ˆæ¯','åŸºç¡€è§’è‰²']},{level:1,name:'VIP1',price:30,benefits:['æ¯æ—¥50æ¡æ¶ˆæ¯','è§£é”æ›´å¤šè§’è‰²','ä¸“å±å®¢æœ']},{level:2,name:'VIP2',price:68,benefits:['æ¯æ—¥100æ¡æ¶ˆæ¯','åˆ›å»ºè‡ªå®šä¹‰è§’è‰²','è¯­éŸ³å›å¤']},{level:3,name:'VIP3',price:128,benefits:['æ— é™æ¶ˆæ¯','æ‰€æœ‰åŠŸèƒ½è§£é”','ä¼˜å…ˆä½“éªŒæ–°åŠŸèƒ½']}];return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">VIPä¼šå‘˜</span></div><div class="vip-header"><div class="icon">ğŸ‘‘</div><h2>${state.user?.vipLevel>0?'VIP'+state.user.vipLevel:'æ™®é€šç”¨æˆ·'}</h2><p>${state.user?.vipLevel>0?'æ„Ÿè°¢æ‚¨çš„æ”¯æŒ':'å¼€é€šVIPäº«å—æ›´å¤šç‰¹æƒ'}</p></div><div class="vip-levels">${levels.map(l=>`<div class="vip-level ${state.user?.vipLevel===l.level?'current':''}"><div class="name">${l.name}</div><div class="price">${l.price>0?'Â¥'+l.price+'/æœˆ':'å…è´¹'}</div><ul style="text-align:left;font-size:12px;color:var(--text-secondary);margin-top:8px;padding-left:16px;">${l.benefits.map(b=>`<li>${b}</li>`).join('')}</ul>${l.price>0?`<button class="btn btn-gold" style="width:100%;margin-top:12px;padding:8px;" onclick="buyVip(${l.level})">å¼€é€š</button>`:''}</div>`).join('')}</div>`;}
function buyVip(level){showToast('æ”¯ä»˜åŠŸèƒ½å¼€å‘ä¸­');}
function renderWalletPage(){return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">æˆ‘çš„é’±åŒ…</span></div><div class="wallet-header"><div class="balance">${state.wallet?.coins||0}</div><div class="label">é‡‘å¸ä½™é¢</div></div><div class="wallet-stats"><div class="stat"><div class="stat-value">${state.wallet?.points||0}</div><div class="stat-label">ç§¯åˆ†</div></div><div class="stat"><div class="stat-value">${state.wallet?.totalCoinsEarned||0}</div><div class="stat-label">ç´¯è®¡è·å¾—</div></div><div class="stat"><div class="stat-value">${state.wallet?.totalCoinsSpent||0}</div><div class="stat-label">ç´¯è®¡æ¶ˆè´¹</div></div></div><div class="card"><h3 style="margin-bottom:16px;">å……å€¼é‡‘å¸</h3><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">${[10,50,100,200,500,1000].map(amount=>`<div style="background:var(--bg);padding:16px;border-radius:8px;text-align:center;cursor:pointer;" onclick="recharge(${amount})"><div style="font-size:18px;font-weight:600;color:var(--gold);">${amount}</div><div style="font-size:12px;color:var(--text-muted);">Â¥${amount}</div></div>`).join('')}</div></div>`;}
function recharge(amount){showToast('å……å€¼åŠŸèƒ½å¼€å‘ä¸­');}
function renderCheckinPage(){const today=new Date();const days=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];const rewards=[10,10,15,15,20,20,30];return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">æ¯æ—¥ç­¾åˆ°</span></div><div class="card" style="text-align:center;padding:30px 20px;"><div style="font-size:48px;margin-bottom:12px;">ğŸ“…</div><h2 style="margin-bottom:8px;">æ¯æ—¥ç­¾åˆ°</h2><p style="color:var(--text-muted);margin-bottom:8px;">è¿ç»­ç­¾åˆ°å¯è·å¾—æ›´å¤šå¥–åŠ±</p><p style="color:var(--primary);font-size:14px;margin-bottom:20px;">å·²è¿ç»­ç­¾åˆ° <span style="font-weight:600;">${state.user?.consecutiveCheckins||0}</span> å¤©</p><button class="btn btn-primary" onclick="handleCheckin()">ç«‹å³ç­¾åˆ° (+${rewards[today.getDay()]}ç§¯åˆ†)</button></div><div class="card"><h3 style="margin-bottom:12px;">æœ¬å‘¨ç­¾åˆ°</h3><div class="checkin-calendar" style="margin:0;">${days.map((day,i)=>{const isToday=today.getDay()===i;const checked=i<today.getDay();return `<div class="checkin-day ${checked?'checked':''} ${isToday?'today':''}"><div class="day">${day}</div><div class="reward">+${rewards[i]}</div></div>`;}).join('')}</div></div>`;}
async function handleCheckin(){try{const result=await api('/checkin',{method:'POST'});showToast(`ç­¾åˆ°æˆåŠŸï¼è·å¾— ${result.points||10} ç§¯åˆ†`);await loadWallet();render();}catch(error){showToast(error.message);}}
function renderInvitePage(){return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">é‚€è¯·å¥½å‹</span></div><div class="card" style="text-align:center;padding:40px 20px;"><div style="font-size:64px;margin-bottom:16px;">ğŸ</div><h2 style="margin-bottom:8px;">é‚€è¯·å¥½å‹</h2><p style="color:var(--text-muted);margin-bottom:24px;">é‚€è¯·å¥½å‹æ³¨å†Œï¼ŒåŒæ–¹éƒ½å¯è·å¾—å¥–åŠ±</p><div style="background:var(--bg);padding:16px;border-radius:8px;margin-bottom:16px;"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">æˆ‘çš„é‚€è¯·ç </div><div style="font-size:24px;font-weight:600;letter-spacing:4px;">${state.user?.inviteCode||'XXXXXX'}</div></div><button class="btn btn-primary" onclick="copyInviteCode()">å¤åˆ¶é‚€è¯·ç </button></div><div class="card"><h3 style="margin-bottom:12px;">é‚€è¯·å¥–åŠ±</h3><div style="display:flex;justify-content:space-around;text-align:center;"><div><div style="font-size:24px;">ğŸ’°</div><div style="font-size:14px;font-weight:500;">50é‡‘å¸</div><div style="font-size:12px;color:var(--text-muted);">ä½ è·å¾—</div></div><div><div style="font-size:24px;">ğŸ</div><div style="font-size:14px;font-weight:500;">30é‡‘å¸</div><div style="font-size:12px;color:var(--text-muted);">å¥½å‹è·å¾—</div></div></div></div>`;}
async function copyInviteCode(){try{const data=await api('/invite/code');const code=data.inviteCode||state.user?.inviteCode||'XXXXXX';navigator.clipboard.writeText(code).then(()=>{showToast('é‚€è¯·ç å·²å¤åˆ¶');}).catch(()=>{showToast('å¤åˆ¶å¤±è´¥');});}catch(error){showToast(error.message);}}
function renderAboutPage(){return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">å…³äºæˆ‘ä»¬</span></div><div class="card" style="text-align:center;padding:40px 20px;"><div style="font-size:64px;margin-bottom:16px;">ğŸ’•</div><h2 style="margin-bottom:8px;">å¾®çˆ±</h2><p style="color:var(--text-muted);margin-bottom:4px;">ç‰ˆæœ¬ 1.0.0</p><p style="color:var(--text-muted);font-size:12px;">AIä¼´ä¾£ï¼Œæ¸©æš–ç›¸ä¼´</p></div><div class="settings-list"><div class="settings-item"><span class="label">ç”¨æˆ·åè®®</span><span class="arrow">â€º</span></div><div class="settings-item"><span class="label">éšç§æ”¿ç­–</span><span class="arrow">â€º</span></div><div class="settings-item"><span class="label">æ„è§åé¦ˆ</span><span class="arrow">â€º</span></div></div>`;}
function renderMyCharactersPage(){return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">æˆ‘çš„è§’è‰²</span><div class="header-actions"><span class="header-action" onclick="navigate('createCharacter')">â•</span></div></div><div style="padding:16px;">${state.myCharacters?.length>0?state.myCharacters.map(char=>`<div class="card" style="display:flex;align-items:center;gap:12px;margin:0 0 12px 0;"><div class="avatar">${getAvatar(char.name,char.avatar)}</div><div style="flex:1;"><div style="font-weight:600;">${char.name}</div><div style="font-size:12px;color:var(--text-muted);">${char.isPublic?'å·²å…¬å¼€':'ç§å¯†'} Â· ${getCategoryLabel(char.category)}</div></div><button class="btn btn-outline" style="padding:6px 12px;font-size:12px;" onclick="editCharacter(${char.id})">ç¼–è¾‘</button></div>`).join(''):`<div class="empty-state"><div class="icon">ğŸ­</div><p>è¿˜æ²¡æœ‰åˆ›å»ºè§’è‰²</p><button class="btn btn-primary" style="margin-top:16px;" onclick="navigate('createCharacter')">åˆ›å»ºè§’è‰²</button></div>`}</div>`;}
function editCharacter(charId){showToast('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­');}
function renderCreateCharacterPage(){return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">åˆ›å»ºè§’è‰²</span></div><div style="padding:16px;"><div class="card"><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">è§’è‰²åç§° *</label><input type="text" class="input" id="charName" placeholder="ç»™è§’è‰²èµ·ä¸ªåå­—"></div><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">è§’è‰²ä»‹ç»</label><textarea class="input" id="charDesc" placeholder="ç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªè§’è‰²" style="height:80px;resize:none;"></textarea></div><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">æ€§æ ¼ç‰¹ç‚¹</label><textarea class="input" id="charPersonality" placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹" style="height:80px;resize:none;"></textarea></div><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">å‰§æƒ…ç®€ä»‹</label><textarea class="input" id="charScenario" placeholder="è§’è‰²çš„èƒŒæ™¯æ•…äº‹æˆ–å‰§æƒ…è®¾å®š" style="height:80px;resize:none;"></textarea></div><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">è§’è‰²åˆ†ç±»</label><select class="input" id="charCategory"><option value="companion">ä¼´ä¾£</option><option value="assistant">åŠ©æ‰‹</option><option value="xianxia">ä»™ä¾ </option><option value="urban">éƒ½å¸‚</option><option value="scifi">ç§‘å¹»</option><option value="otome">ä¹™æ¸¸</option></select></div><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">æ€§åˆ«</label><select class="input" id="charGender"><option value="female">å¥³</option><option value="male">ç”·</option><option value="other">å…¶ä»–</option></select></div><div class="form-group" style="margin-bottom:16px;display:flex;align-items:center;gap:8px;"><input type="checkbox" id="charPublic"><label for="charPublic" style="font-size:13px;">å…¬å¼€è§’è‰²ï¼ˆå…¶ä»–ç”¨æˆ·å¯è§ï¼‰</label></div><button class="btn btn-primary" style="width:100%;" onclick="createCharacter()">åˆ›å»ºè§’è‰²</button></div></div>`;}
async function createCharacter(){const name=document.getElementById('charName').value;const description=document.getElementById('charDesc').value;const personality=document.getElementById('charPersonality').value;const scenario=document.getElementById('charScenario').value;const category=document.getElementById('charCategory').value;const gender=document.getElementById('charGender').value;const isPublic=document.getElementById('charPublic').checked;if(!name){showToast('è¯·è¾“å…¥è§’è‰²åç§°');return;}try{await api('/characters',{method:'POST',body:JSON.stringify({name,description,personality,scenario,category,gender,isPublic})});showToast('è§’è‰²åˆ›å»ºæˆåŠŸ');navigate('myCharacters');}catch(error){showToast(error.message);}}
function renderApiConfigPage(){return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">APIé…ç½®</span></div><div style="padding:16px;"><div class="card"><h3 style="margin-bottom:16px;">è‡ªå®šä¹‰API</h3><p style="color:var(--text-muted);font-size:13px;margin-bottom:16px;">é…ç½®æ‚¨è‡ªå·±çš„AIæœåŠ¡APIï¼Œæ”¯æŒOpenAIã€Claudeç­‰</p><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">APIæä¾›å•†</label><select class="input" id="apiProvider"><option value="openai">OpenAI</option><option value="claude">Claude</option><option value="deepseek">DeepSeek</option><option value="custom">è‡ªå®šä¹‰</option></select></div><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">API Key</label><input type="password" class="input" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„API Key"></div><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">API URLï¼ˆå¯é€‰ï¼‰</label><input type="text" class="input" id="apiUrl" placeholder="è‡ªå®šä¹‰APIåœ°å€"></div><div class="form-group" style="margin-bottom:16px;"><label style="display:block;font-size:13px;color:var(--text-secondary);margin-bottom:6px;">æ¨¡å‹åç§°ï¼ˆå¯é€‰ï¼‰</label><input type="text" class="input" id="apiModel" placeholder="ä¾‹å¦‚ï¼šgpt-4, claude-3-opus"></div><button class="btn btn-primary" style="width:100%;" onclick="saveApiConfig()">ä¿å­˜é…ç½®</button><button class="btn btn-outline" style="width:100%;margin-top:12px;" onclick="testApiConfig()">æµ‹è¯•è¿æ¥</button></div></div>`;}
async function saveApiConfig(){const provider=document.getElementById('apiProvider').value;const apiKey=document.getElementById('apiKey').value;const apiUrl=document.getElementById('apiUrl').value;const model=document.getElementById('apiModel').value;if(!apiKey){showToast('è¯·è¾“å…¥API Key');return;}try{await api('/user/api-config',{method:'POST',body:JSON.stringify({provider,apiKey,apiUrl,model})});showToast('APIé…ç½®å·²ä¿å­˜');}catch(error){showToast(error.message);}}
async function testApiConfig(){const provider=document.getElementById('apiProvider').value;const apiKey=document.getElementById('apiKey').value;const apiUrl=document.getElementById('apiUrl').value;if(!apiKey){showToast('è¯·è¾“å…¥API Key');return;}try{await api('/user/api-config/test',{method:'POST',body:JSON.stringify({provider,apiKey,apiUrl})});showToast('è¿æ¥æˆåŠŸï¼');}catch(error){showToast('è¿æ¥å¤±è´¥ï¼š'+error.message);}}
function renderVoiceSettingsPage(){return `<div class="header"><span class="header-back" onclick="goBack()">â€¹</span><span class="header-title">è¯­éŸ³è®¾ç½®</span></div><div style="padding:16px;"><div class="card"><h3 style="margin-bottom:16px;">è¯­éŸ³å›å¤</h3><div class="settings-item" style="padding:0;border:none;"><span class="label">å¯ç”¨è¯­éŸ³å›å¤</span><input type="checkbox" id="voiceEnabled"></div></div><div class="card"><h3 style="margin-bottom:16px;">è¯­éŸ³éŸ³è‰²</h3><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">${['ç”œç¾å¥³å£°','æ¸©æŸ”ç”·å£°','æ´»æ³¼å°‘å¥³','æˆç†Ÿå¾¡å§'].map((voice,i)=>`<div style="background:var(--bg);padding:12px;border-radius:8px;text-align:center;cursor:pointer;" onclick="selectVoice(${i})"><div style="font-size:24px;margin-bottom:4px;">ğŸ”Š</div><div style="font-size:13px;">${voice}</div></div>`).join('')}</div></div></div>`;}
function selectVoice(voiceId){showToast('è¯­éŸ³è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­');}
async function loadInitialData(){try{if(state.token){const [userInfo,wallet]=await Promise.all([api('/auth/me'),api('/wallet/info').catch(()=>({coins:0,points:0}))]);state.user=userInfo;state.wallet=wallet;}const characters=await api('/characters');state.characters=characters.characters||characters||[];if(state.token){const [sessions,contacts]=await Promise.all([api('/chat/sessions').catch(()=>[]),api('/contacts').catch(()=>[])]);state.sessions=sessions||[];state.contacts=contacts||[];}}catch(error){console.error('Load data error:',error);}}
async function loadHomeData(){try{const [characters,sessions]=await Promise.all([api('/characters?limit=6'),state.token?api('/chat/sessions').catch(()=>[]):Promise.resolve([])]);state.characters=characters.characters||characters||[];state.sessions=sessions||[];}catch(error){console.error('Load home data error:',error);}}
async function loadCharacters(){try{const characters=await api('/characters');state.characters=characters.characters||characters||[];}catch(error){console.error('Load characters error:',error);}}
async function loadSessions(){try{const sessions=await api('/chat/sessions');state.sessions=sessions||[];}catch(error){console.error('Load sessions error:',error);}}
async function loadContacts(){try{const contacts=await api('/contacts');state.contacts=contacts||[];}catch(error){console.error('Load contacts error:',error);}}
async function loadWallet(){try{const wallet=await api('/wallet/info');state.wallet=wallet;}catch(error){console.error('Load wallet error:',error);}}
async function loadGifts(){try{const gifts=await api('/gifts');state.gifts=gifts||[];}catch(error){console.error('Load gifts error:',error);}}
async function loadMoments(){try{const moments=await api('/moments');state.moments=moments||[];}catch(error){console.error('Load moments error:',error);}}
async function loadMyCharacters(){try{const characters=await api('/characters/my');state.myCharacters=characters||[];}catch(error){console.error('Load my characters error:',error);}}
async function loadRankings(){try{const rankings=await api(`/rankings/${state.rankType}`);state.rankings=rankings||[];}catch(error){console.error('Load rankings error:',error);state.rankings=[];}}
async function init(){if(state.token){try{await loadInitialData();}catch(error){console.error('Init error:',error);state.token=null;localStorage.removeItem('token');}}render();}
init();
</script>
</body>
</html>
