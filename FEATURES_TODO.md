# 微爱 - 新功能实现 TODO

## Phase 5: 暗黑模式和角色市场

### 5.1 暗黑模式 - 前端 UI
- [ ] 添加主题切换按钮到设置页面
- [ ] 创建暗黑模式CSS变量
- [ ] 更新所有页面样式支持暗黑模式
- [ ] localStorage保存主题偏好
- [ ] 系统主题自动检测
- [ ] 暗黑模式下的图片优化
- [ ] 测试所有页面暗黑模式显示

### 5.2 暗黑模式 - 后端支持
- [ ] 用户表添加 themePreference 字段
- [ ] 创建 GET /api/user/theme 端点
- [ ] 创建 POST /api/user/theme 端点
- [ ] 主题偏好持久化到数据库

### 5.3 角色市场 - 数据库
- [ ] 创建 characterListings 表（角色上架）
- [ ] 创建 characterPurchases 表（购买记录）
- [ ] 创建 characterReviews 表（评价）
- [ ] 添加字段：价格、销量、评分、描述

### 5.4 角色市场 - 后端 API
- [ ] POST /api/marketplace/list - 上架角色
- [ ] GET /api/marketplace/listings - 获取上架列表
- [ ] POST /api/marketplace/purchase - 购买角色
- [ ] GET /api/marketplace/my-listings - 我的上架
- [ ] GET /api/marketplace/my-purchases - 我的购买
- [ ] POST /api/marketplace/review - 评价角色
- [ ] GET /api/marketplace/earnings - 卖家收入统计
- [ ] DELETE /api/marketplace/listings/:id - 下架角色
- [ ] PUT /api/marketplace/listings/:id - 编辑上架信息

### 5.5 角色市场 - 前端页面
- [ ] 创建 Marketplace.jsx 页面
- [ ] 浏览标签页（排序、筛选、搜索）
- [ ] 我的上架标签页
- [ ] 已购买标签页
- [ ] 角色卡片组件（显示价格、销量、评分）
- [ ] 购买确认对话框
- [ ] 上架角色表单
- [ ] 卖家统计面板

### 5.6 角色市场 - 功能实现
- [ ] 实现购买逻辑（金币扣除、角色转移）
- [ ] 实现平台抽成机制（10%）
- [ ] 实现卖家收入计算
- [ ] 实现评价系统
- [ ] 实现排序功能（热度、最新、评分、价格）
- [ ] 实现搜索功能
- [ ] 实现分类筛选

---

## Phase 6: 分享和导出功能

### 6.1 分享功能 - 后端
- [ ] 创建 shareRecords 表
- [ ] POST /api/chat/share - 创建分享链接
- [ ] GET /api/chat/share/:shareId - 获取分享内容
- [ ] 生成分享ID（短链接）
- [ ] 支持HTML格式导出
- [ ] 支持XML格式导出
- [ ] 设置分享过期时间（可选）
- [ ] 分享访问统计

### 6.2 分享功能 - 前端
- [ ] 在聊天页面添加分享按钮
- [ ] 创建分享对话框
- [ ] 显示分享链接
- [ ] 生成二维码
- [ ] 复制分享链接功能
- [ ] 选择分享格式（HTML/XML）
- [ ] 分享预览

### 6.3 聊天记录导出 - 后端
- [ ] POST /api/chat/export - 导出聊天记录
- [ ] 支持多种格式（JSON、CSV、HTML、XML、PDF）
- [ ] 支持日期范围筛选
- [ ] 支持角色筛选
- [ ] 生成导出文件

### 6.4 聊天记录导出 - 前端
- [ ] 在聊天页面添加导出按钮
- [ ] 创建导出对话框
- [ ] 选择导出格式
- [ ] 选择日期范围
- [ ] 显示导出进度
- [ ] 下载导出文件

### 6.5 分享和导出 - 功能测试
- [ ] 测试HTML分享格式
- [ ] 测试XML分享格式
- [ ] 测试各种导出格式
- [ ] 测试分享链接有效性
- [ ] 测试导出文件完整性

---

## Phase 7: 性能优化和安全增强

### 7.1 性能优化 - 缓存层
- [ ] 安装 redis 包
- [ ] 配置 Redis 连接
- [ ] 缓存用户信息
- [ ] 缓存角色列表
- [ ] 缓存排行榜数据
- [ ] 缓存商品列表
- [ ] 实现缓存失效策略

### 7.2 性能优化 - 数据库
- [ ] 添加用户表索引
- [ ] 添加角色表索引
- [ ] 添加聊天消息表索引
- [ ] 添加时间戳索引
- [ ] 优化查询语句
- [ ] 添加查询分析

### 7.3 性能优化 - 前端
- [ ] 代码分割（按页面）
- [ ] 懒加载组件
- [ ] 图片优化和压缩
- [ ] 移除未使用的CSS
- [ ] 压缩JavaScript
- [ ] 启用Gzip压缩

### 7.4 安全增强 - 注册验证
- [ ] 集成验证码服务（Google reCAPTCHA 或国内方案）
- [ ] 前端显示验证码
- [ ] 后端验证验证码
- [ ] 注册表单添加验证码字段

### 7.5 安全增强 - 注册限制
- [ ] 创建 registrationAttempts 表
- [ ] 实现同设备限制（Device Fingerprint）
- [ ] 实现同IP限制
- [ ] 每小时最多注册数限制
- [ ] 每天最多注册数限制
- [ ] 实现IP黑名单功能
- [ ] 实现设备黑名单功能

### 7.6 安全增强 - 速率限制
- [ ] 安装 express-rate-limit 包
- [ ] 实现登录速率限制
- [ ] 实现注册速率限制
- [ ] 实现API通用速率限制
- [ ] 实现聊天消息速率限制
- [ ] 实现支付速率限制
- [ ] 自定义速率限制错误响应

### 7.7 安全增强 - CORS限制
- [ ] 配置CORS白名单
- [ ] 限制允许的源
- [ ] 限制允许的方法
- [ ] 限制允许的头
- [ ] 设置凭证策略
- [ ] 测试CORS配置

### 7.8 安全增强 - 其他
- [ ] 实现CSRF防护
- [ ] 实现XSS防护
- [ ] 实现SQL注入防护
- [ ] 实现输入验证
- [ ] 实现输出编码
- [ ] 添加安全头（Helmet.js）

### 7.9 性能监控 - 后端
- [ ] 安装 APM 工具（如 Elastic APM）
- [ ] 配置性能监控
- [ ] 监控API响应时间
- [ ] 监控数据库查询时间
- [ ] 监控错误率
- [ ] 监控内存使用

### 7.10 性能监控 - 前端
- [ ] 集成前端性能监控
- [ ] 监控页面加载时间
- [ ] 监控首屏渲染时间
- [ ] 监控用户交互响应时间
- [ ] 监控错误日志
- [ ] 上报到后端

---

## Phase 8: 推送功能和自动化测试

### 8.1 推送功能 - 后端
- [ ] 创建 notifications 表
- [ ] 创建 userSubscriptions 表（推送订阅）
- [ ] 安装 web-push 包
- [ ] 配置 Web Push 服务
- [ ] POST /api/notifications/subscribe - 订阅推送
- [ ] POST /api/notifications/send - 发送推送
- [ ] GET /api/notifications - 获取通知列表
- [ ] POST /api/notifications/:id/read - 标记已读

### 8.2 推送功能 - 前端
- [ ] 注册 Service Worker
- [ ] 请求推送权限
- [ ] 保存推送订阅信息
- [ ] 处理推送消息
- [ ] 显示推送通知
- [ ] 点击推送打开应用

### 8.3 推送功能 - 触发器
- [ ] 新消息推送
- [ ] 礼物接收推送
- [ ] 朋友圈互动推送
- [ ] 排行榜更新推送
- [ ] 系统公告推送
- [ ] 营销推送（可选）

### 8.4 自动化测试 - 单元测试
- [ ] 安装 Jest 测试框架
- [ ] 配置测试环境
- [ ] 编写认证API测试
- [ ] 编写角色管理测试
- [ ] 编写聊天功能测试
- [ ] 编写支付功能测试
- [ ] 编写排行榜测试
- [ ] 目标覆盖率: 80%+

### 8.5 自动化测试 - 集成测试
- [ ] 编写端到端测试
- [ ] 测试用户注册流程
- [ ] 测试聊天流程
- [ ] 测试支付流程
- [ ] 测试角色市场流程
- [ ] 测试分享导出流程

### 8.6 自动化测试 - 性能测试
- [ ] 编写性能基准测试
- [ ] 测试API响应时间
- [ ] 测试数据库查询性能
- [ ] 测试并发处理能力
- [ ] 生成性能报告

### 8.7 自动化测试 - 安全测试
- [ ] 测试SQL注入防护
- [ ] 测试XSS防护
- [ ] 测试CSRF防护
- [ ] 测试认证机制
- [ ] 测试授权机制

### 8.8 CI/CD 配置
- [ ] 配置 GitHub Actions
- [ ] 自动运行单元测试
- [ ] 自动运行集成测试
- [ ] 自动代码质量检查
- [ ] 自动生成测试报告
- [ ] 自动部署到测试环境

---

## Phase 9: 最终测试和部署

### 9.1 功能测试
- [ ] 测试所有新功能
- [ ] 测试暗黑模式
- [ ] 测试角色市场
- [ ] 测试分享功能
- [ ] 测试导出功能
- [ ] 测试推送功能

### 9.2 兼容性测试
- [ ] 测试不同浏览器
- [ ] 测试不同设备
- [ ] 测试不同操作系统
- [ ] 测试不同网络环境

### 9.3 性能测试
- [ ] 测试页面加载速度
- [ ] 测试API响应时间
- [ ] 测试并发处理
- [ ] 生成性能报告

### 9.4 安全测试
- [ ] 进行安全审计
- [ ] 测试验证码功能
- [ ] 测试注册限制
- [ ] 测试速率限制
- [ ] 生成安全报告

### 9.5 用户验收测试
- [ ] 邀请测试用户
- [ ] 收集反馈
- [ ] 修复问题
- [ ] 优化体验

### 9.6 文档更新
- [ ] 更新README
- [ ] 更新API文档
- [ ] 更新部署指南
- [ ] 更新用户指南
- [ ] 更新开发指南

### 9.7 部署准备
- [ ] 准备发布版本
- [ ] 创建发布说明
- [ ] 准备迁移脚本
- [ ] 准备回滚方案

### 9.8 部署和发布
- [ ] 部署到生产环境
- [ ] 监控系统状态
- [ ] 收集用户反馈
- [ ] 及时修复问题

---

## 优先级排序

### 立即实现（第1周）
1. ✅ 暗黑模式 UI
2. ✅ 验证码集成
3. ✅ 注册限制
4. ✅ 速率限制

### 第2周
5. ✅ 角色市场 - 后端
6. ✅ 角色市场 - 前端
7. ✅ CORS限制
8. ✅ 数据库索引

### 第3周
9. ✅ 分享功能
10. ✅ 导出功能
11. ✅ 缓存层
12. ✅ 前端优化

### 第4周
13. ✅ 推送功能
14. ✅ 性能监控
15. ✅ 自动化测试
16. ✅ 最终测试和部署

---

## 总工作量估计

| 功能 | 工作量 | 难度 |
|------|--------|------|
| 暗黑模式 | 6h | 低 |
| 角色市场 | 20h | 中 |
| 分享功能 | 12h | 中 |
| 导出功能 | 10h | 中 |
| 性能优化 | 15h | 中 |
| 安全增强 | 18h | 中 |
| 推送功能 | 16h | 高 |
| 自动化测试 | 20h | 中 |
| **总计** | **117小时** | - |

---

**最后更新**: 2026-01-11
